const express = require('express');
const cors = require('cors');
const multer = require('multer');
const {spawn} =require('child_process');

const app = express();
app.use(cors());
app.use(express.json());

const malware = {
  "0": "Benign",
  "1": "RedLineStealer",
  "2": "Downloader",
  "3": "RAT",
  "4": "BankingTrojan",
  "5": "SnakeKeyLogger",
  "6": "Spyware"
}


const storage = multer.diskStorage({
    destination: (req, file, cb) => {
      cb(null, './public/files');
    },
    filename: (req, file, cb) => {
      cb(null, `${Date.now()}_${file.originalname}`);
    }
});

const upload = multer({storage}).single('file');

app.post('/upload',upload, (req, res) => {
  // console.log(req.body);
  console.log(req.file);
  // console.log(req.file.filename);
  const python = spawn('python', ['./model/__main__.py', `./public/files/${req.file.filename}`]);
  python.stdout.on('data', (data) => {
    const result = data.toString().trim().split(',');
    const resultJson = {
      api_model: malware[result[0]],
      ddl_model: malware[result[1]],
      pe_model: malware[result[2]],
      ps_model: malware[result[3]]
    };
    res.send(resultJson);
  });
  python.stderr.on('data', (data) => {
    console.error(data.toString());
    res.send("Internal Server Error");
  });
  python.on('close', (code) => {
    console.log(`child process close all stdio with code ${code}`);
    // res.send('success');
  });
});

app.listen(5000, () => {
  console.log('Server is running on port 3000');
});